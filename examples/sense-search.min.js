function logError(a){console.log(a)}function Subscription(){this.callbackList=[]}function logError(a){console.log(a)}var SenseSearchSpeech=function(){function a(a,c){if("undefined"==typeof senseSearch&&c.senseSearch&&(senseSearch=c.senseSearch),"undefined"!=typeof document){var d=document.createElement("div");d.id=a,d.classList.add("sense-search-speech-container");var e=b.replace(/{id}/gim,a);d.innerHTML=e}"undefined"!=typeof SpeechRecognition?(this.SpeechRecognition=SpeechRecognition,this.SpeechGrammarList=SpeechGrammarList):"undefined"!=typeof webkitSpeechRecognition&&(this.SpeechRecognition=webkitSpeechRecognition,this.SpeechGrammarList=webkitSpeechGrammarList),c=c||{};for(var f in c)this[f]=c[f];if(this.id=a,"undefined"!=typeof document){d.onclick=this.onClick.bind(this);var g=document.getElementById(a);if(g){g.attributes.mode&&d.setAttribute("data-mode",g.attributes.mode.value),g.insertAdjacentElement?g.insertAdjacentElement("afterEnd",d):g.insertAdjacentHTML("afterEnd",d.outerHTML);for(var h=0;h<g.attributes.length;h++)this[g.attributes[h].name]=g.attributes[h].value;g.parentNode.removeChild(g)}this.SpeechRecognition?(this.enabled=!0,this.recognition=new this.SpeechRecognition,this.synth=window.speechSynthesis,this.voices=this.synth.getVoices(),this.recognition.lang=this.recognitionLanguage,this.recognition.continuous=this.continuousRecognition,this.recognition.interimResults=this.interimResults,this.recognition.onstart=this.recognitionStart.bind(this),this.recognition.onstop=this.recognitionStop.bind(this),this.recognition.onaudioend=this.recognitionAudioEnd.bind(this),this.recognition.onerror=this.recognitionError.bind(this),this.recognition.onresult=this.recognitionResult.bind(this),this.recognition.onend=this.recognitionEnd.bind(this),this.inputId||(this.inputId=Object.keys(senseSearch.inputs)[0]),this.ready=new Subscription,this.onSpeechResult=new Subscription,senseSearch.ready.subscribe(this.activate.bind(this)),senseSearch.inputs[this.inputId].onAmbiguity.subscribe(this.onSearchAmbiguity.bind(this)),senseSearch.cleared.subscribe(this.onClear.bind(this))):d.classList.add("sense-search-no-support")}return{element:d,object:this}}var b="<button class='sense-search-mic' id='{id}_micButton'></button>";return a.prototype=Object.create(Object.prototype,{enabled:{writable:!0,value:!1},awaitingResolve:{writable:!0,value:!1},recognitionLanguage:{writable:!0,value:"en-GB"},listenOnActivate:{writable:!0,value:!1},listening:{writable:!0,value:!1},continuousRecognition:{writable:!0,value:!0},interimResults:{writable:!0,value:!1},clearWords:{writable:!0,value:["clear"]},replaceWords:{writable:!0,value:["replace"]},replaceWithWords:{writable:!0,value:["with"]},safeWords:{writable:!0,value:[]},safeWordFirst:{writable:!0,value:!1},stopAfterResult:{writable:!0,value:!1},onClick:{value:function(a){a.target.classList.contains("sense-search-mic")&&(this.listening===!1?this.recognise():this.recognition.stop())}},ready:{writable:!0},onSpeechResult:{writable:!0},activate:{value:function(){this.setClass(!0,"sense-search-ready"),this.listenOnActivate===!0&&this.recognise()}},recognise:{value:function(){this.listening=!0,this.recognition.start()}},onSearchAmbiguity:{value:function(a){var b=this;this.listening===!0&&(this.awaitingResolve||(this.recognition.stop(),currentAmbiguity=a,this.awaitingResolve=!0,this.speak("what do you mean by "+a.term.text+"?."),setTimeout(function(){try{b.recognition.start()}catch(c){console.log(c)}senseSearch.inputs[b.inputId].showAmbiguityOptions(a.termIndex)},2e3)))}},onClear:{value:function(){this.awaitingResolve=!1}},setClass:{value:function(a,b){if("undefined"!=typeof document){var c=document.getElementById(this.id);c&&a===!0?c.classList.add(b):c&&a===!1&&c.classList.remove(b)}}},recognitionStart:{value:function(a){console.log("recognition started"),this.setClass(!0,"sense-search-listening")}},recognitionStop:{value:function(a){console.log("recognition stopped"),this.setClass(!1,"sense-search-listening")}},recognitionAudioEnd:{value:function(){console.log("audio end");try{this.recognition.start()}catch(a){}}},recognitionError:{value:function(a){console.log("recognition error"),console.log(a),this.recognition.stop()}},recognitionEnd:{value:function(){this.setClass(!1,"sense-search-listening")}},recognitionResult:{value:function(a){for(var b=a.resultIndex;b<a.results.length;b++)if(a.results[b].isFinal){var c=senseSearch.inputs[this.inputId].searchText||"";c=c.trim(),this.stopAfterResult===!0&&this.recognition.stop();var d=a.results[b][0].transcript.trim();if(this.onSpeechResult.deliver(d),""===d)return;console.log(d);var e=a.results[b].isFinal;if(1===d.split(" ").length&&-1!==this.clearWords.indexOf(d.toLowerCase().trim()))return void senseSearch.clear();for(var f=0;f<this.replaceWords.length;f++)if(-1!==d.toLowerCase().indexOf(this.replaceWords[f])){var g=d.replace(this.replaceWords[f],""),h=this.getReplaceParts(g);Array.isArray(h)?-1===c.indexOf(h[0].trim())?this.speak("I'm not sure what you want me to replace."):""===h[1].trim()?this.speak("I'm not sure what you want me to replace."):(c=c.replace(h[0].trim(),h[1].trim()),senseSearch.inputs[this.inputId].setSearchText(c,!e)):this.speak("I'm not sure what you want me to replace.")}if(this.awaitingResolve===!0){for(var b=0;b<currentAmbiguity.fields.length;b++)if(-1!==d.indexOf(currentAmbiguity.fields[b])){this.awaitingResolve=!1,senseSearch.inputs[this.inputId].resolveAmbiguity(currentAmbiguity.termIndex,currentAmbiguity.fields[b]);break}this.awaitingResolve&&this.speak("I didn't catch that.")}if(this.safeWords.length>0)for(var b=0;b<this.safeWords.length;b++){var i=(c+" "+d).indexOf(this.safeWords[b]);if(-1===i||safeWordFirst&&i>0)return}c+=" "+d,senseSearch.inputs[this.inputId].setSearchText(c,!e)}}},speak:{value:function(a){if(this.listening===!0){var b=this;this.recognition.stop(),this.speaking=!0;var c=new SpeechSynthesisUtterance(a);c.voice=this.voices[0],c.addEventListener("end",function(a){b.speaking=!1,console.log("utterance ended");try{b.recognition.start()}catch(c){console.log(c)}"undefined"!=typeof callbackFn&&callbackFn()}),c.onerror=function(a){console.log("utterance error")},c.onpause=function(a){console.log("utterance pause")},this.synth.speak(c)}}},getReplaceParts:{value:function(a){for(var b,c=0;c<this.replaceWithWords.length;c++)return-1!==a.indexOf(this.replaceWithWords[c])&&(b=this.replaceWithWords[c]),a.split(b)}}}),a}(),SenseSearchInput=function(){function a(a,b){if("undefined"==typeof senseSearch&&b.senseSearch&&(senseSearch=b.senseSearch),b&&"undefined"!=typeof b.searchEntity?this.searchEntity=b.searchEntity:this.searchEntity=senseSearch,"undefined"!=typeof document){var c=document.createElement("div");c.id=a,c.classList.add("sense-search-input-container");var d=j.replace(/{id}/gim,a);c.innerHTML=d}this.clearAllOnClear=!0,b=b||{};for(var e in b)this[e]=b[e];if(this.id=a,"undefined"!=typeof document){c.onkeyup=this.onKeyUp.bind(this),c.onkeydown=this.onKeyDown.bind(this),c.onclick=this.onClick.bind(this);var f=document.getElementById(a);if(f){f.attributes.mode&&c.setAttribute("data-mode",f.attributes.mode.value),f.insertAdjacentElement?f.insertAdjacentElement("afterEnd",c):f.insertAdjacentHTML("afterEnd",c.outerHTML);for(var g=0;g<f.attributes.length;g++)this[f.attributes[g].name]=f.attributes[g].value;f.parentNode.removeChild(f)}}return this.searchFields&&!Array.isArray(this.searchFields)&&this.searchFields.length&&(this.searchFields=this.searchFields.split(",")),this.suggestFields&&!Array.isArray(this.suggestFields)&&this.suggestFields.length&&(this.suggestFields=this.suggestFields.split(",")),this.searchTimeout=this.searchTimeout||300,this.suggestTimeout=this.suggestTimeout||100,this.chartTimeout=this.chartTimeout||300,this.ready=new Subscription,this.onAmbiguity=new Subscription,this.blockingTerms={},this.blockingTermKeys=[],this.searchEntity.ready.subscribe(this.activate.bind(this)),this.searchEntity.fieldsFetched.subscribe(this.fieldsFetched.bind(this)),this.searchEntity.onSelectionsApplied.subscribe(this.refresh.bind(this)),this.searchEntity.onLockedUnlocked.subscribe(this.refresh.bind(this)),this.searchEntity.searchAssociations.subscribe(this.onSearchAssociations.bind(this)),this.searchEntity.suggestResults.subscribe(this.onSuggestResults.bind(this)),this.searchEntity.cleared.subscribe(this.onClear.bind(this)),this.searchEntity.searchStarted.subscribe(this.onSearchStarted.bind(this)),{element:c,object:this}}function b(a){return a.toLowerCase().replace(/ /gi,"_")}function c(a){return a.replace(/_/gi," ")}function d(a){var b=a.qText,c=a.qElemNumber;b=b.split("");var d;null!=a.qRanges[0]&&(d={qText:a.qText.substring(a.qRanges[0].qCharPos,a.qRanges[0].qCharPos+a.qRanges[0].qCharCount)});for(var e=a.qRanges.length-1;e>-1;e--)b.splice(a.qRanges[e].qCharPos+a.qRanges[e].qCharCount,0,"</span>"),b.splice(a.qRanges[e].qCharPos,0,"<span class='highlight"+a.qRanges[e].qTerm+"'>");return b=b.join("").replace(/<(?!\/?span(?=>|\s.*>))\/?.*?>/gim,""),{text:b,elem:c,matchValue:d}}function e(a,b){var c=a.toLowerCase();for(console.log("suggest base 0"),console.log(c),b=b.toLowerCase(),console.log("suggestion"),console.log(b);-1==b.indexOf(c);)c=c.split(" "),c.splice(0,1),c=c.join(" ");var d=new RegExp(c,"i");return b.replace(d,"")}function f(a){var b={};for(var c in a)b[c]=a[c];return b}var g=[16,27],h=[9,13,38,40,39,37,32,33,34],i={BACKSPACE:8,ESCAPE:27,CONTROL:17,COMMAND:91,PASTE:86,TAB:9,ENTER:13,SHIFT:16,UP:38,DOWN:40,RIGHT:39,LEFT:37,DELETE:46,SPACE:32},j="<div class='sense-search-input-main'><div id='{id}_ghost' class='sense-search-input-bg'></div><input id='{id}_input' autofocus placeholder='Please wait...' disabled='disabled' type='text' autocorrect='off' autocomplete='off' autocapitalize='off' spellcheck='false'/><div id='{id}_lozenges' class='sense-search-lozenge-container'></div><div id='{id}_ambiguities' class='sense-search-ambiguity-container'></div><button type='button' class='sense-search-input-clear'>x</button></div><div id='{id}_suggestions' class='sense-search-suggestion-container'><ul id='{id}_suggestionList'></ul></div><div id='{id}_associations' class='sense-search-association-container'><ul id='{id}_associationsList'></ul></div>";return a.prototype=Object.create(Object.prototype,{id:{writable:!0,value:null},MAX_SEARCH_TERMS:{writable:!0,value:20},ready:{writable:!0,value:null},searchEntity:{writable:!0},onAmbiguity:{writable:!0,value:null},blockingTerms:{writable:!0},blockingTermKeys:{writable:!0},includeMasterMeasures:{writable:!0,value:!1},usingMasterMeasures:{writable:!0,value:!1},showTimeSeriesAsLine:{writable:!0,value:!0},groupingStyle:{writable:!0,value:"stacked"},attach:{value:function(a){if(a)for(var b in a)this[b]=a[b];"visualizations"==this.mode?this.searchEntity.getAppFields(this.nlpModel.cardinalityLimit,this.includeMasterMeasures):this.activateInput(),this.searchEntity&&this.searchEntity.exchange.connection&&(this.searchEntity.inputs[this.id]||(this.searchEntity.inputs[this.id]=this))}},isCutCopyPaste:{writable:!0,value:!1},isPaste:{writable:!0,value:!1},searchText:{writable:!0,value:null},currentTerm:{writable:!0,value:null},searchFields:{writable:!0,value:[]},suggestFields:{writable:!0,value:[]},searchTimeout:{writable:!0,value:null},suggestTimeout:{writable:!0,value:null},chartTimeout:{writable:!0,value:null},searchTimeoutFn:{writable:!0,value:null},suggestTimeoutFn:{writable:!0,value:null},chartTimeoutFn:{writable:!0,value:null},suggesting:{writable:!0,value:!1},associating:{writable:!0,value:!1},suggestingTimeout:{writable:!0,value:3e3},suggestingTimeoutFn:{writable:!0,value:null},activeSuggestion:{writable:!0,value:0},ghostPart:{writable:!0,value:null},ghostQuery:{writable:!0,value:null},ghostDisplay:{writable:!0,value:null},cursorPosition:{writable:!0,value:0},allowNLP:{writable:!0,value:!1},nlpTerms:{writable:!0,value:[]},nlpSilentTerms:{writable:!0,value:{}},nlpResolvedTerms:{writable:!0,value:{}},nlpDistinctTerms:{writable:!0,value:{}},nlpTermsIndexes:{writable:!0,value:[]},nlpTermsPositions:{writable:!0,value:[]},nlpModel:{value:{fieldNounMap:{},fieldTagMap:{},functionMap:{avg:"avg",average:"avg",count:"count","how many":"count",sum:"sum",total:"sum","how much":"sum",min:"min",max:"max"},functionLabelMap:{sum:"Total",avg:"Average",count:"Count",min:"Minimum",max:"Maximum"},distinctMap:{distinct:"DISTINCT",unique:"DISTINCT"},negationMap:["not","ignore","ignoring","exclude","excluding","without"],defaultFunction:"sum",currencySymbol:"£",misc:["by","as","is","was","were","me","not","ignore","the","in","of","a","and","what","show"],comparatives:{more:">",less:"<",greater:">",above:">",below:"<",cheaper:"<"},conditionals:["where","for","is","from"],sorting:["order","ordered","sort","sorted"],sortorder:{asc:1,ascending:1,lowest:1,least:1,desc:-1,descending:-1,highest:-1,most:-1},vizTypeMap:{kpi:"kpi",barchart:"barchart","bar chart":"barchart",linechart:"linechart",piechart:"piechart",combochart:"combochart",table:"table",treemap:"treemap",scatter:"scatterplot",scatterplot:"scatterplot","scatter chart":"scatterplot",boxplot:"boxplot",distributionplot:"distributionplot",histogram:"histogram"},cardinalityLimit:1e3}},fieldsFetched:{value:function(a){this.activateInput()}},lastSelectedGroup:{writable:!0,value:null},lastAssociationSummary:{writable:!0,value:null},lastSelectedAssociation:{writable:!0,value:null},appFields:{writable:!0,value:{}},appFieldsByTag:{writable:!0,value:{}},suggestions:{writable:!0,value:null},associations:{writable:!0,value:null},ambiguities:{writable:!0,value:[]},mode:{writable:!0,value:"associations"},addFieldNoun:{value:function(a,b){a=c(a),this.nlpModel.fieldNounMap[a]||(this.nlpModel.fieldNounMap[a]=[]),-1===this.nlpModel.fieldNounMap[a].indexOf(b)&&this.nlpModel.fieldNounMap[a].push(b)}},addFieldTag:{value:function(a,c){var d=b(a);if(this.nlpModel.fieldTagMap[d]||(this.nlpModel.fieldTagMap[d]=[]),"object"==typeof c&&c.length)for(var e=0;e<c.length;e++)-1===this.nlpModel.fieldTagMap[d].indexOf(c[e])&&this.nlpModel.fieldTagMap[d].push(c[e]);else-1===this.nlpModel.fieldTagMap[d].indexOf(c)&&this.nlpModel.fieldTagMap[d].push(c)}},onClear:{value:function(){if("undefined"!=typeof document){var a=document.getElementById(this.id+"_input");a&&(a.value="")}this.searchText="",this.nlpTerms=[],this.nlpResolvedTerms={},this.nlpTermsPositions=[],this.currentTerm=null,this.lastSelectedGroup=null,this.usingMasterMeasures=!1,this.hideSuggestions(),this.hideAssociations(),this.clearLozenges()}},onSearchResults:{value:function(){}},searching:{writable:!0,value:!1},onSearchStarted:{value:function(){}},onSearchAssociations:{value:function(a){if(console.log("associations are"),console.log(a),this.searching=!1,"associations"==this.mode)this.associations=a.qResult,this.showAssociations();else{console.log(a),this.associations=a;for(var d=0;d<this.associations.length;d++){console.log("ambiguities"),console.log(this.associations[d]);var e=[],g=this.transformAssociations(this.associations[d]),h=this.getTermByText(this.associations[d].qSearchTerms[this.associations[d].qSearchTerms.length-1]);if(!(h&&h.length>0))return;h=h[0];var i=this.getTermIndexByText(this.associations[d].qSearchTerms[this.associations[d].qSearchTerms.length-1]);if(!(i&&i.length>0))return;if(i=i[0],console.log(h),console.log(i),0==g.length)h.queryTag="!!";else{for(var j=0;j<g.length;j++){var k=c(g[j].id);console.log(k),console.log(b(g[j].id));var l=h.text.indexOf(k);if(-1!==l){var m=f(h);m.text=k,m.parsedText=k,m.name=k,m.length=k.length,m.tempPosition=l,m.extra={fields:g[j].fields},g[j].fields.length>1?m.senseType="?":(m.queryTag=g[j].fields[0],m.senseTag="value",m.senseType="value",m.senseInfo={field:this.searchEntity.appFields[b(g[j].fields[0])],fieldSelection:"="}),e.push(m)}}this.nlpTerms.splice(i,1),e=e.sort(function(a,b){return a.tempPosition-b.tempPosition});for(var j=e.length;j>0;j--)e[j-1].position=i+(j-1),this.nlpTerms.splice(i,0,e[j-1]),e[j-1].extra.fields.length>1&&this.addAmbiguity(e[j-1].text,{termIndex:e[j-1].position,term:e[j-1],fields:e[j-1].extra.fields})}console.log(this.nlpTerms),this.buildLozenges(),this.nlpViz()}}}},onSuggestResults:{value:function(a){this.suggestions=a.qSuggestions,this.suggestions.splice(5,a.qSuggestions.length-4),this.suggestions.length>0&&(this.activeSuggestion=0),this.showSuggestions()}},transformAssociations:{value:function(a){var b={},c=[],d=[],e=this.getTermByText(a.qSearchTerms[a.qSearchTerms.length-1]);if(!(e&&e.length>0))return[];e=e[0];var f=e.text.split(" ");e.text.split(" ").length;if(a.qSearchGroupArray.length>0&&a.qSearchGroupArray[0].qSearchTermsMatched.length>0)for(var g=0;g<a.qSearchGroupArray[0].qItems.length;g++)if("Field"===a.qSearchGroupArray[0].qItems[g].qItemType)for(var h=a.qSearchGroupArray[0].qItems[g].qIdentifier,i=0;i<a.qSearchGroupArray[0].qItems[g].qItemMatches.length;i++)c.push({terms:a.qSearchGroupArray[0].qItems[g].qSearchTermsMatched,field:h});for(var j=[],k=[],l=0;l<c.length;l++){for(var m=[],n=0;n<c[l].terms.length;n++)m.push(f[c[l].terms[n]]);var o=k.indexOf(m.join("_"));-1===o&&(k.push(m.join("_")),o=k.length-1,j.push({id:m.join("_"),terms:c[l].terms,fields:[]})),-1==j[o].fields.indexOf(c[l].field)&&j[o].fields.push(c[l].field)}transformationsToDelete=[];for(var l=0;l<j.length;l++){for(var p=!0,n=0;n<j[l].terms.length;n++)if(-1!==d.indexOf(j[l].terms[n])){p=!1;break}p===!1?transformationsToDelete.push(l):d=d.concat(j[l].terms)}for(var l=transformationsToDelete.length-1;l>-1;l--)j.splice(transformationsToDelete[l],1);return console.log(b),console.log(c),console.log(j),j}},getTerm:{value:function(a){return this.nlpTerms[a.replace(/ /gi,"_")]}},setCurrentTerm:{value:function(a){this.currentTerm=a[this.getCurrentTermIndex()]}},getTermByText:{value:function(a){for(var b=[],c=0;c<this.nlpTerms.length;c++)this.nlpTerms[c].text!=a||this.nlpTerms[c].senseType&&""!=this.nlpTerms[c].senseType||b.push(this.nlpTerms[c]);return b}},getTermIndexByText:{value:function(a){for(var b=[],c=0;c<this.nlpTerms.length;c++)this.nlpTerms[c].text!=a||this.nlpTerms[c].senseType&&""!=this.nlpTerms[c].senseType||b.push(c);return b}},getCurrentTermIndex:{value:function(){return this.nlpTermsPositions[this.cursorPosition-1]}},processTerms:{value:function(a,d){console.log("setting back to false"),this.usingMasterMeasures=!1,a=a.toLowerCase();var e=a,f=a,g=[],h=[];for(var i in this.searchEntity.appFields){var j,k;if(this.searchEntity.appFields[i].qInfo){j=this.searchEntity.appFields[i].qData.title;var l;"measure"===this.searchEntity.appFields[i].qInfo.qType?(l="exp",k="measure"):"dimension"===this.searchEntity.appFields[i].qInfo.qType?(l="dim",k="dimension"):(l="dim",k="field")}else j=this.searchEntity.appFields[i].qName,this.searchEntity.appFields[i].isMasterItem,this.searchEntity.appFieldsByTag.$measure&&this.searchEntity.appFieldsByTag.$measure[i]?(l="exp",k="measure"):this.nlpModel.fieldTagMap[i]&&-1!==this.nlpModel.fieldTagMap[i].indexOf("$measure")?(l="exp",k="field"):(l="dim",k="field");var m=b(j),n=c(m),o=a.indexOf(n),p=-1;if(-1==o&&this.nlpModel.fieldNounMap[n])for(var q=0;q<this.nlpModel.fieldNounMap[n].length;q++)if(-1!==a.indexOf(this.nlpModel.fieldNounMap[n][q].toLowerCase())){p=a.indexOf(this.nlpModel.fieldNounMap[n][q].toLowerCase()),j=this.nlpModel.fieldNounMap[n][q],n=this.nlpModel.fieldNounMap[n][q].toLowerCase();break}if(-1!==o||-1!==p){var r=-1===o?p:o;if(r>0&&" "!==a.split("")[r-1])continue;if(a.split("")[r+n.length]&&" "!==a.split("")[r+n.length])continue;if(-1==h.indexOf(n)&&-1!==f.indexOf(n)){e=e.replace(n,";||"+n+";"),f=f.replace(n,""),console.log(e),console.log(f);var s={name:i,text:j,parsedText:n,position:r,length:j.length,senseType:k,senseGroup:l,queryTag:k,senseInfo:{field:this.searchEntity.appFields[i]}};this.searchEntity.appFieldsByTag.$time&&this.searchEntity.appFieldsByTag.$time[i]?s.senseInfo.type="time":this.searchEntity.appFieldsByTag.$timestamp&&this.searchEntity.appFieldsByTag.$timestamp[i]?s.senseInfo.type="time":this.nlpModel.fieldTagMap[b(j)]&&-1!==this.nlpModel.fieldTagMap[b(j)].indexOf("$time")&&(s.senseInfo.type="time"),h.push(n),this.searchEntity.appFields[i].isMasterItem&&(this.usingMasterMeasures=!0,console.log("setting back to true")),g.push(s)}}}var t=e.split(";");console.log(t);for(var u=[],v=0;v<t.length;v++){var w=0;if(w=0==v?0:u[v-1]+t[v-1].replace("||","").length,u.push(w),-1==t[v].indexOf("||")&&t[v].length>0)for(var x=t[v].split(" "),y=0,z=0;z<x.length;z++)0==z&&" "==t[v].split()[0]?y=1:y++,x[z].length>0&&g.push({name:x[z],text:x[z],parsedText:x[z],position:w+y,length:x[z].length}),y+=x[z].length}g.sort(function(a,b){return a.position<b.position?-1:a.position>b.position?1:0}),this.createTermPosArray(g),this.nlpTerms=[];for(var A=0;A<g.length;A++)if(this.nlpResolvedTerms[g[A].name])this.nlpTerms.push(this.nlpResolvedTerms[g[A].name]);else{var B=this.tagTerm(g[A]);B.queryTag||console.log("no tag"),this.nlpTerms.push(B)}for(var A=0;A<this.nlpTerms.length;A++)this.nlpTerms[A]&&this.nlpTerms[A+1]&&(this.nlpTerms[A].queryTag||this.nlpTerms[A+1].queryTag||(this.joinTerms(A,A+1),A--));console.log(this.nlpTerms)}},createTermPosArray:{value:function(a){this.nlpTermsPositions=[];for(var b=0;b<a.length;b++){for(var c=a[b].text.split(""),d=0;d<c.length;d++)this.nlpTermsPositions.push(b);b<a.length-1?this.nlpTermsPositions.push(-1):b==a.length-1&&" "==this.searchText.split("").pop&&this.nlpTermsPositions.push(-1)}}},joinTerms:{value:function(a,b){this.nlpTerms[a].length+=this.nlpTerms[b].length+1,this.nlpTerms[a].text+=" "+this.nlpTerms[b].text,this.nlpTerms[a].name=c(this.nlpTerms[a].text),this.nlpTerms[a].parsedText=this.nlpTerms[a].name,this.nlpTerms.splice(b,1)}},tagTerm:{value:function(a){var b=a.text.toLowerCase(),c=this.getCurrentTermIndex();return a.queryTag||(this.nlpModel.functionMap[b]?(a.senseType="function",a.senseInfo={func:this.nlpModel.functionMap[b]},a.queryTag="function"):-1!=this.nlpModel.sorting.indexOf(b)?a.queryTag="sorting":this.nlpModel.sortorder[b]?(a.queryTag="sortorder",this.nlpTerms[c-1]&&"sort by"===this.nlpTerms[c-1].queryTag?this.nlpTerms[c-1].senseInfo.order=this.nlpModel.sortorder[b]:(a.senseType="sortorder",a.senseInfo={order:this.nlpModel.sortorder[b]})):this.nlpModel.vizTypeMap[b]?(a.queryTag="viz",a.senseType="viz",a.senseInfo={viz:this.nlpModel.vizTypeMap[b]}):this.nlpModel.distinctMap[b]?a.queryTag="distinct":this.nlpModel.comparatives[b]?a.queryTag="!":-1!=this.nlpModel.conditionals.indexOf(b)?a.queryTag="!":-1!=this.nlpModel.misc.indexOf(b)&&(a.queryTag="!")),a}},clear:{value:function(){this.clearAllOnClear===!0?this.searchEntity.clear():this.onClear()}},onClick:{value:function(a){if(a.target.classList.contains("sense-search-input-clear"))this.clear();else if(a.target.classList.contains("sense-search-suggestion-item"))this.activeSuggestion=parseInt(a.target.attributes["data-index"].value),this.drawGhost(),this.acceptSuggestion();else if(a.target.classList.contains("sense-search-association-item")||a.target.parentNode.classList.contains("sense-search-association-item")||a.target.parentNode.parentNode.classList.contains("sense-search-association-item")){var b;b=a.target.classList.contains("sense-search-association-item")?parseInt(a.target.attributes["data-index"].value):a.target.parentNode.classList.contains("sense-search-association-item")?parseInt(a.target.parentNode.attributes["data-index"].value):parseInt(a.target.parentNode.parentNode.attributes["data-index"].value),this.lastSelectedGroup=b,this.lastAssociationSummary&&this.lastAssociationSummary.length>0&&(this.lastSelectedAssociation=this.lastAssociationSummary[b]),this.searchEntity.selectAssociations(this.searchFields||[],b,this.context||"LockedFieldsOnly"),this.hideAssociations(),this.hideSuggestions()}else if(a.target.classList.contains("ambiguity")){var c=a.target.attributes["data-term"].value;this.showAmbiguityOptions(c)}else if(a.target.classList.contains("ambiguous_resolve")){var c=a.target.attributes["data-term"].value,d=a.target.innerText;this.resolveAmbiguity(c,d)}}},onKeyDown:{value:function(a){if(a.keyCode==i.ESCAPE)return void this.hideSuggestions();if(a.keyCode==i.CONTROL||a.keyCode==i.COMMAND)return void(this.isCutCopyPaste=!0);if(a.keyCode==i.PASTE&&this.isCutCopyPaste)return void(this.isPaste=!0);if(a.keyCode==i.DOWN)this.showSuggestions();else if(a.keyCode==i.RIGHT)this.suggesting&&(a.preventDefault(),this.nextSuggestion());else if(a.keyCode==i.LEFT)this.suggesting&&(a.preventDefault(),this.prevSuggestion());else if(a.keyCode==i.ENTER||a.keyCode==i.TAB)this.suggesting?(a.preventDefault(),this.acceptSuggestion()):this.associating&&a.keyCode==i.ENTER&&(a.preventDefault(),this.searchEntity.selectAssociations(this.searchFields||[],0),this.hideAssociations());else if(a.keyCode==i.SPACE){if(this.searchText.split(" ").length==this.MAX_SEARCH_TERMS)return alert("Too many search terms"),a.preventDefault(),!1;if(1==this.searchText.split(" ").pop().length&&"visualizations"!==this.mode)return alert("cannot search for single character strings"),a.preventDefault(),!1;this.hideSuggestions(),this.hideAssociations()}else this.hideSuggestions(),this.hideAssociations()}},onKeyUp:{value:function(a){a.keyCode==i.Control&&(this.isCutCopyPaste=!1);var b=document.getElementById(this.id+"_input");b&&(this.searchText=b.value,this.cursorPosition=a.target.selectionStart,"visualizations"===this.mode&&(this.processTerms(this.searchText,!this.isPaste),this.buildLozenges(),this.isPaste=!1),-1==g.indexOf(a.keyCode)&&-1==h.indexOf(a.keyCode)&&("visualizations"===this.mode?this.preVizSearch():this.preSearch()))}},preSearch:{value:function(){if(this.searchText&&this.searchText.length>0){if(this.searchText.split(" ").pop().length>1){var a=this;this.searchTimeoutFn&&clearTimeout(this.searchTimeoutFn),this.searchTimeoutFn=setTimeout(function(){a.search()},this.searchTimeout),this.searchText.length>1&&this.cursorPosition==this.searchText.length&&(this.suggestTimeoutFn&&clearTimeout(this.suggestTimeoutFn),this.suggestTimeoutFn=setTimeout(function(){a.suggest()},this.suggestTimeout))}}else this.clear()}},preVizSearch:{value:function(){this.searchEntity.cleanUpOldVizObjects();var a=!1;if(this.searchText&&this.searchText.trim().length>1){var b=this;this.searchTimeoutFn&&clearTimeout(this.searchTimeoutFn),this.searchTimeoutFn=setTimeout(function(){for(var c=0;c<b.nlpTerms.length;c++)b.nlpTerms[c].senseType||b.nlpTerms[c].queryTag||(a=!0,b.searchForSingleTerm(b.nlpTerms[c].text))},this.searchTimeout),this.searchText.length>1&&this.cursorPosition==this.searchText.length&&(this.suggestTimeoutFn&&clearTimeout(this.suggestTimeoutFn),this.suggestTimeoutFn=setTimeout(function(){b.suggest()},this.suggestTimeout)),this.chartTimeoutFn&&clearTimeout(this.chartTimeoutFn),this.chartTimeoutFn=setTimeout(function(){this.blockingTermKeys&&0!=this.blockingTermKeys.length||a||b.nlpViz()},this.chartTimeout)}this.searchText&&0!=this.searchText.length||this.clear()}},replaceSearchText:{value:function(a,b,c){var d=this.searchText+" ";return-1===d.indexOf(a)?!1:(d=d.replace(parts[0],parts[1]),void this.setSearchText(d,c))}},setSearchText:{value:function(a,b){if(b=b||!1,this.searchText=a,this.isPaste=!0,this.cursorPosition=a.length,"undefined"!=typeof document){var c=document.getElementById(this.id+"_input");c&&(c.value=a)}"visualizations"!==this.mode||b?b||this.preSearch():(this.processTerms(this.searchText,!this.isPaste),this.buildLozenges(),this.preVizSearch()),this.isPaste=!1}},refresh:{value:function(){this.setSearchText(this.searchText)}},showSuggestions:{value:function(){if(this.startSuggestionTimeout(),this.searchText&&this.searchText.length>1&&this.cursorPosition==this.searchText.length&&this.suggestions.length>0){if(this.suggesting=!0,this.drawGhost(),"undefined"!=typeof document){var a=document.getElementById(this.id+"_suggestions");a&&(a.style.display="block")}this.drawSuggestions()}else this.suggesting=!1,this.removeGhost(),this.hideSuggestions()}},hideSuggestions:{value:function(){if(this.suggesting=!1,this.activeSuggestion=0,this.ghostPart="",this.ghostQuery="",this.ghostDisplay="",this.removeGhost(),"undefined"!=typeof document){var a=document.getElementById(this.id+"_suggestions");a&&(a.style.display="none")}}},showAssociations:{value:function(){var a="";this.associating=!0,this.lastAssociationSummary=[];for(var b=this.associations.qSearchGroupArray,c=0;c<b.length;c++){a+="<li class='sense-search-association-item' data-index='"+c+"'>";for(var e=[],f=0;f<b[c].qItems.length;f++){var g="";b[c].qItems.length>1&&(g="width: "+Math.floor(100/b[c].qItems.length)+"%;");var h=b[c].qItems[f],i=b[c].qItems[f].qIdentifier,j=[],k=[],l=[];for(var m in h.qItemMatches){var n=d(h.qItemMatches[m],h.qSearchTerms);k.push(n.matchValue),j.push(n.text),l.push(n.elem)}a+="<div style='"+g+"'>",a+="<h1>"+i+"</h1>";for(var m=0;m<j.length;m++)a+=j[m],m<j.length-1&&(a+=", ");a+="</div>",e.push({field:i,values:k,elems:l})}a+="</li>",this.lastAssociationSummary.push(e)}if("undefined"!=typeof document){var o=document.getElementById(this.id+"_associationsList");o&&(o.innerHTML=a);var p=document.getElementById(this.id+"_associations");p&&(p.style.display="block")}}},hideAssociations:{value:function(){if("undefined"!=typeof document){var a=document.getElementById(this.id+"_associations");a&&(a.style.display="none"),this.associating=!1}}},addAmbiguity:{value:function(a,b){this.ambiguities[a]=b,this.onAmbiguity.deliver(b)}},showAmbiguityOptions:{value:function(a){if("undefined"!=typeof document){var b=document.getElementById("ambiguous_"+a);b&&(b.style.display="initial")}}},resolveAmbiguity:{value:function(a,c){"undefined"==typeof senseSearch&&this.senseSearch&&(senseSearch=this.senseSearch,this.searchEntity=this.senseSearch),this.nlpTerms[a].senseType="value",this.nlpTerms[a].queryTag=c,this.nlpTerms[a].senseInfo={field:this.searchEntity.appFields[b(c)],fieldSelection:"="},this.nlpTerms[a-1]&&this.nlpTerms[a-1].text&&"not"===this.nlpTerms[a-1].text.toLowerCase()&&(this.nlpTerms[a].senseInfo.fieldSelection="-="),this.nlpResolvedTerms[this.nlpTerms[a].name]=this.nlpTerms[a],this.buildLozenges(),this.nlpViz(),delete this.ambiguities[this.nlpTerms[a].name]}},buildLozenges:{value:function(){var a="",b="";for(var c in this.nlpTerms){if(a+="<div class='lozenge' ",this.nlpTerms[c].queryTag&&""!==this.nlpTerms[c].queryTag&&(a+=" data-querytag='"+this.nlpTerms[c].queryTag+"'"),this.nlpTerms[c].senseType&&""!==this.nlpTerms[c].senseType&&(a+=" data-sensetag='"+this.nlpTerms[c].senseType+"'"),a+=">",a+=this.nlpTerms[c].parsedText,a+="</div>",b+="<div class='ambiguity-provision' data-querytag='"+this.nlpTerms[c].queryTag+"'>",b+=this.nlpTerms[c].parsedText,"?"==this.nlpTerms[c].senseType){b+="<div class='ambiguity' data-term='"+c+"'>?</div>",b+="<ul id='ambiguous_"+c.replace(/ /gi,"_")+"' style='display: none;'>";for(var d=0;d<this.nlpTerms[c].extra.fields.length;d++)b+="<li class='ambiguous_resolve' data-term='"+c+"'>",b+=this.nlpTerms[c].extra.fields[d],b+="</li>"}b+="</ul>",b+="</div>"}if("undefined"!=typeof document){var e=document.getElementById(this.id+"_lozenges");e&&(e.innerHTML=a);var f=document.getElementById(this.id+"_ambiguities");f&&(f.innerHTML=b)}}},clearLozenges:{value:function(){if("undefined"!=typeof document){var a=document.getElementById(this.id+"_lozenges");a&&(a.innerHTML="");var b=document.getElementById(this.id+"_ambiguities");b&&(b.innerHTML="")}}},startSuggestionTimeout:{value:function(){this.suggestingTimeoutFn&&clearTimeout(this.suggestingTimeoutFn),this.suggestingTimeoutFn=setTimeout(function(){"associations"!==this.mode&&this.hideSuggestions.call(this)}.bind(this),this.suggestingTimeout)}},nextSuggestion:{value:function(){this.startSuggestionTimeout(),this.activeSuggestion==this.suggestions.length-1?this.activeSuggestion=0:this.activeSuggestion++,this.drawGhost(),this.highlightActiveSuggestion()}},prevSuggestion:{value:function(){this.startSuggestionTimeout(),0==this.activeSuggestion?this.activeSuggestion=this.suggestions.length-1:this.activeSuggestion--,this.drawGhost(),
this.highlightActiveSuggestion()}},acceptSuggestion:{value:function(){if(this.searchText=this.ghostQuery,this.suggestions=[],this.hideSuggestions(),"undefined"!=typeof document){var a=document.getElementById(this.id+"_input");a&&(a.value=this.searchText)}"visualizations"===this.mode&&(this.processTerms(this.searchText),this.buildLozenges(),this.preVizSearch()),this.search()}},search:{value:function(){"undefined"==typeof senseSearch&&this.senseSearch&&(senseSearch=this.senseSearch,this.searchEntity=this.senseSearch),this.searchEntity.search(this.searchText,this.searchFields||[],this.mode,this.context||"LockedFieldsOnly")}},searchForSingleTerm:{value:function(a){this.searching=!0,"undefined"==typeof senseSearch&&this.senseSearch&&(senseSearch=this.senseSearch,this.searchEntity=this.senseSearch),this.blockingTerms[b(a)]=!0,this.blockingTermKeys=Object.keys(this.blockingTerms),console.log("blocking: "+a),this.searchEntity.search(a,this.searchFields||[],this.mode,this.context||"LockedFieldsOnly")}},suggest:{value:function(){"undefined"==typeof senseSearch&&this.senseSearch&&(senseSearch=this.senseSearch,this.searchEntity=this.senseSearch),this.searchEntity.suggest(this.searchText,this.suggestFields||[])}},nlpViz:{value:function(){"undefined"==typeof senseSearch&&this.senseSearch&&(senseSearch=this.senseSearch,this.searchEntity=this.senseSearch),console.log("creating viz");var a,c={qInfo:{},qHyperCubeDef:{qDimensions:[],qMeasures:[],qInitialDataFetch:[{qTop:0,qLeft:0,qHeight:1e3,qWidth:10}]}},d={},e={},f=[],g={},h={},i=0,j=[],k=null,l=null,m={},n={},o=0,p=0;this.nlpSilentTerms||(this.nlpSilentTerms={}),this.nlpSilentTerms&&this.nlpSilentTerms.viz&&(a=this.nlpModel.vizTypeMap[this.nlpSilentTerms.viz]);for(var q=0;q<this.nlpTerms.length;q++)if("measure"==this.nlpTerms[q].senseType&&p++,"dimension"==this.nlpTerms[q].senseType)o++;else if("field"==this.nlpTerms[q].senseType){var r=-1;this.nlpTerms[q-1]&&"!"!=this.nlpTerms[q-1].queryTag?r=q-1:this.nlpTerms[q-1]&&"!"==this.nlpTerms[q-1].queryTag&&this.nlpTerms[q-2]?r=q-2:this.nlpTerms[q+1]&&(r=q+1),-1!==r?this.nlpModel.distinctMap[this.nlpTerms[r].text]?(this.nlpTerms[q].senseGroup="exp",this.nlpTerms[q].senseInfo.countDistinct=!0,this.nlpTerms[q].senseInfo.func="count",p++):"function"==this.nlpTerms[r].senseType?(this.nlpTerms[q].senseGroup="exp",this.nlpTerms[q].senseInfo.func=this.nlpTerms[r].senseInfo.func,p++):o++:o++}if(0==p)for(var q=0;q<this.nlpTerms.length;q++)(this.searchEntity.appFieldsByTag.$measure[this.nlpTerms[q].name]||this.searchEntity.appFieldsByTag.$possibleMeasure[this.nlpTerms[q].name])&&(this.nlpTerms[q].senseGroup="exp",p++),0==p&&1==o?"dim"!=this.nlpTerms[q].senseGroup||!this.searchEntity.appFieldsByTag.$numeric[this.nlpTerms[q].name]||this.searchEntity.appFieldsByTag.$measure[this.nlpTerms[q].name]||this.searchEntity.appFieldsByTag.$possibleMeasure[this.nlpTerms[q].name]?"field"==this.nlpTerms[q].senseType&&(this.searchEntity.appFieldsByTag.$measure[this.nlpTerms[q].name]||this.searchEntity.appFieldsByTag.$possibleMeasure[this.nlpTerms[q].name])?(this.nlpTerms[q].senseGroup="exp",a="kpi"):a="table":a="histogram":0==p&&"field"==this.nlpTerms[q].senseType&&"histogram"!=a&&this.nlpTerms[q].senseInfo.field&&!this.nlpTerms[q].senseInfo.field.qData&&(this.searchEntity.appFieldsByTag.$possibleMeasure&&this.searchEntity.appFieldsByTag.$possibleMeasure[this.nlpTerms[q].name]?(this.nlpTerms[q].senseGroup="exp",p++,this.searchEntity.appFieldsByTag.$numeric&&this.searchEntity.appFieldsByTag.$numeric[this.nlpTerms[q].name]?this.nlpTerms[q].senseInfo.func=this.nlpModel.defaultFunction:this.nlpTerms[q].senseInfo.func="count"):(this.nlpTerms[q].senseGroup="exp",this.nlpTerms[q].senseInfo.countDistinct=!0,this.nlpTerms[q].senseInfo.func="count"));o=-1,p=-1;for(var q=0;q<this.nlpTerms.length;q++){switch(this.nlpTerms[q].senseGroup){case"exp":var s=this.nlpTerms[q],t=s.name,u="";t=s.senseInfo.field.qInfo?s.senseInfo.field.qData.title.replace(/ /gi,"-"):this.nlpTerms[q].senseInfo.field.qName.replace(/ /gi,"-"),e[t]={field:this.nlpTerms[q].senseInfo.field},this.nlpTerms[q].senseInfo.countDistinct&&(e[t].isCountDistinct=!0,u+="Distinct "),this.nlpTerms[q].senseInfo.func?(e[t].func=this.nlpTerms[q].senseInfo.func,u+=this.nlpModel.functionLabelMap[this.nlpTerms[q].senseInfo.func]+("count"==this.nlpTerms[q].senseInfo.func?" of ":" ")):u+="<<func>> ",this.nlpTerms[q].senseInfo.field.qName?u+=this.nlpTerms[q].senseInfo.field.qName:this.nlpTerms[q].senseInfo.field.qData&&(u+=this.nlpTerms[q].senseInfo.field.qData.title),e[t].label=u,p++,n[t]=p;break;case"dim":var v=this.nlpTerms[q],w=this.nlpTerms[q].name;v.senseInfo.field.qInfo?d[w]={qLibraryId:v.senseInfo.field.qInfo.qId}:(w=this.nlpTerms[q].senseInfo.field.qName.replace(/ /gi,"-"),d[w]=this.nlpTerms[q].senseInfo.field),d[w].qDef||(d[w].qDef={}),d[w].qDef.qSortCriterias=[{qSortByAscii:1}],"time"==this.nlpTerms[q].senseInfo.type&&j.push(w),o++,m[w]=o}switch(this.nlpTerms[q].senseType){case"function":k=this.nlpTerms[q].senseInfo.func;break;case"value":var x,y,z;if(this.nlpTerms[q].senseInfo.field&&this.nlpTerms[q].senseInfo.field.qInfo)z=b(this.nlpTerms[q].senseInfo.field.qData.title),x=this.nlpTerms[q].senseInfo.field.qData.title,y=this.nlpTerms[q].senseInfo.field.qInfo.qId;else{if(!this.nlpTerms[q].senseInfo.field){console.log("failed term"),console.log(this.nlpTerms[q]);continue}z=b(this.nlpTerms[q].senseInfo.field.qName),x=this.nlpTerms[q].senseInfo.field.qName}h[z]||(h[z]={field:{name:x,id:y},selector:this.nlpTerms[q].senseInfo.fieldSelection,values:[],selectValues:[]});var A="";A+="'",A+=this.nlpTerms[q].text,A+="*'",h[z].selectValues.push(this.nlpTerms[q].text),h[z].values.push(A),i++;break;case"sortfield":var B=this.nlpTerms[q].senseInfo.field.qName.replace(/ /gi,"-");g[B]=this.nlpTerms[q].senseInfo;break;case"sortorder":l=this.nlpTerms[q].senseInfo.order;break;case"viz":a=this.nlpTerms[q].senseInfo.viz}}for(var C in d){var D={};if(d[C].qLibraryId?(D=d[C],D.qNullSuppression=!0):D={qDef:{qFieldDefs:[d[C].qName]},qNullSuppression:!0},D.name=C,g[C]){var E="qSortByAscii",F=g[C].order||1;this.searchEntity.appFieldsByTag.$numeric&&-1!=this.searchEntity.appFieldsByTag.$numeric.indexOf(C)&&(E="qSortByNumeric"),D.qDef.qSortCriterias=[{}],D.qDef.qSortCriterias[0][E]=F}c.qHyperCubeDef.qDimensions.push(D),f.push(d[C].qName)}for(var G in e){var H={};if(e[G].field.qInfo&&e[G].field.qInfo.qId&&"measure"==e[G].field.qInfo.qType)H.qLibraryId=e[G].field.qInfo.qId;else{var I="=num(",J=e[G].func||k||this.nlpModel.defaultFunction;if(e[G].label=e[G].label.replace(/\<\<func\>\>/gim,this.nlpModel.functionLabelMap[J]),-1!==e[G].label.toLowerCase().indexOf("count")&&-1===e[G].label.toLowerCase().indexOf("count of")&&(e[G].label=e[G].label.replace(/count/i,"Count of ")),I+=J,I+="(",e[G].isCountDistinct&&(I+="DISTINCT "),I+="{$",i>0&&this.usingMasterMeasures===!1){I+="<",setLabelsCount=0;var K=[];for(var L in h){var M="";0==setLabelsCount&&"-="!=h[L].selector?e[G].label+=" for ":"-="==h[L].selector&&(e[G].label+=" excluding "),e[G].label+=h[L].values.join(", "),M+="["+h[L].field.name+"]",M+=h[L].selector,M+="{",M+=h[L].values.join(","),M+="}",K.push(M)}I+=K.join(","),I+=">"}I+="}",I+=e[G].field.qInfo?"["+e[G].field.qData.title+"]":"["+e[G].field.qName+"]",I+="), '";var N;e[G].field.qName?N=b(e[G].field.qName):e[G].field.qData&&(N=b(e[G].field.qData.title)),this.searchEntity.appFieldsByTag.$currency&&this.searchEntity.appFieldsByTag.$currency[G]&&"count"!==k?I+=this.nlpModel.currencySymbol:this.nlpModel.fieldTagMap[N]&&-1!==this.nlpModel.fieldTagMap[N].indexOf("$currency")&&"count"!==k&&(I+=this.nlpModel.currencySymbol),I+="#,##0')";var H={qDef:{qDef:I,qLabel:e[G].label,sortLabel:e[G].field.qName}};if(f.push(e[G].field.qName),g[G]){var E="qSortByNumeric",F=g[G].order||1;H.qSortBy={},H.qSortBy[E]=F,c.qHyperCubeDef.qInterColumnSortOrder=[f.indexOf(e[G].field.qName)]}}c.qHyperCubeDef.qMeasures.push(H)}var O=0;for(var L in g)O++;var P=c.qHyperCubeDef.qDimensions.length+c.qHyperCubeDef.qMeasures.length;if(0==O&&c.qHyperCubeDef.qDimensions&&c.qHyperCubeDef.qDimensions.length>0)if(j.length>0){var Q=m[j[0]];c.qHyperCubeDef.qDimensions[Q].qDef||(c.qHyperCubeDef.qDimensions[Q].qDef={}),c.qHyperCubeDef.qDimensions[Q].qDef.qSortCriterias=[{qSortByNumeric:l||1}],c.qHyperCubeDef.qInterColumnSortOrder=new Array(P).fill(),c.qHyperCubeDef.qInterColumnSortOrder=c.qHyperCubeDef.qInterColumnSortOrder.map(function(a,b){return b}),console.log(c.qHyperCubeDef.qInterColumnSortOrder)}else if(c.qHyperCubeDef.qMeasures.length>0){c.qHyperCubeDef.qMeasures[0].qSortBy={qSortByNumeric:l||-1};var R=new Array(c.qHyperCubeDef.qDimensions.length+c.qHyperCubeDef.qMeasures.length).fill().map(function(a,b){return b});R.splice(R.indexOf(c.qHyperCubeDef.qDimensions.length),1),R.splice(0,0,c.qHyperCubeDef.qDimensions.length),c.qHyperCubeDef.qInterColumnSortOrder=R}else c.qHyperCubeDef.qDimensions.length>0;if(a||(1==P&&c.qHyperCubeDef.qMeasures.length>0?a=this.nlpModel.vizTypeMap.kpi:1==P&&c.qHyperCubeDef.qDimensions.length>0&&this.searchEntity.appFieldsByTag.$numeric[c.qHyperCubeDef.qDimensions[0].name]?a=this.nlpModel.vizTypeMap.histogram:(2==c.qHyperCubeDef.qDimensions.length&&(c.barGrouping={grouping:this.groupingStyle}),c.qHyperCubeDef.qMeasures.length>0?c.qHyperCubeDef.qMeasures.length>2?a=this.nlpModel.vizTypeMap.table:2==c.qHyperCubeDef.qMeasures.length&&"scatterplot"!=a?(a=this.nlpModel.vizTypeMap.combochart,c.qHyperCubeDef.qMeasures[0].qDef||(c.qHyperCubeDef.qMeasures[0].qDef={}),c.qHyperCubeDef.qMeasures[1].qDef||(c.qHyperCubeDef.qMeasures[1].qDef={}),c.qHyperCubeDef.qMeasures[0].qDef.series={type:"bar",axis:0,marker:"circle",markerFill:!0},c.qHyperCubeDef.qMeasures[1].qDef.series={type:"line",axis:1,marker:"line",markerFill:!0}):a=j.length>0&&this.showTimeSeriesAsLine===!0?this.nlpModel.vizTypeMap.linechart:this.nlpModel.vizTypeMap.barchart:a=this.nlpModel.vizTypeMap.table)),c.qInfo.qType=this.nlpModel.vizTypeMap[a]||a,"table"==c.qInfo.qType,c.qHyperCubeDef.qDimensions.length>0||c.qHyperCubeDef.qMeasures.length>0)if(i=Object.keys(h).length,i>0&&this.usingMasterMeasures===!0){var S=this;S.searchEntity.clear(!1,!0,function(){S.preVizSelect(0,i,h,function(){S.searchEntity.createViz(c)})})}else{var S=this;S.searchEntity.clear(!1,!0,function(){S.searchEntity.createViz(c)})}}},preVizSelect:{value:function(a,b,c,d){var e=this;console.log("sets:",b),console.log(c);var f=Object.keys(c),g=f[a];c[g]?this.searchEntity.lowLevelSelectTextInField(c[g].field,c[g].selectValues,!1,function(){a++,b>a?e.preVizSelect(a,b,c,d):d()}):d()}},drawGhost:{value:function(){if(this.ghostPart=e(this.searchText,this.suggestions[this.activeSuggestion].qValue),console.log("ghost part"),console.log(this.ghostPart),this.ghostQuery=this.searchText+this.ghostPart,"undefined"!=typeof document){var a="<span style='color: transparent;'>"+this.searchText+"</span>"+this.ghostPart,b=document.getElementById(this.id+"_ghost");b&&(b.innerHTML=a)}}},removeGhost:{value:function(){if("undefined"!=typeof document){var a=document.getElementById(this.id+"_ghost");a&&(a.innerHTML="")}}},drawSuggestions:{value:function(){for(var a="",b=0;b<this.suggestions.length;b++)a+="<li id='"+this.id+"_suggestion_"+b+"' class='sense-search-suggestion-item' data-index='"+b+"'>",a+=this.suggestions[b].qValue,a+="</li>";if("undefined"!=typeof document){var c=document.getElementById(this.id+"_suggestionList");c&&(c.innerHTML=a)}this.highlightActiveSuggestion()}},highlightActiveSuggestion:{value:function(){if("undefined"!=typeof document){var a=document.getElementById(this.id+"_suggestionList");if(a)for(var b=0;b<a.childElementCount;b++)a.childNodes[b].classList.remove("active");var c=document.getElementById(this.id+"_suggestion_"+this.activeSuggestion);c&&c.classList.add("active")}}},activate:{value:function(){this.attach()}},activateInput:{value:function(){if("undefined"!=typeof document){var a=document.getElementById(this.id+"_input");a&&(a.attributes.placeholder.value=this.placeholder||"Enter up to "+this.MAX_SEARCH_TERMS+" search terms",a.disabled=!1,console.log("input activated"),this.ready.deliver())}}}}),a}(),SenseSearchResult=function(){function a(a,b){var c=document.createElement("div");c.id=a,c.classList.add("sense-search-results-container"),this.resultsElement=a+"_results",this.loadingElement=a+"_results_loading";var e=d.replace(/{id}/gim,a);c.innerHTML=e,b=b||{};for(var f in b)this[f]=b[f];b&&"undefined"!=typeof b.searchEntity?this.searchEntity=b.searchEntity:this.searchEntity=senseSearch,this.id=a;var g=document.getElementById(a);if(g){g.insertAdjacentElement?g.insertAdjacentElement("afterEnd",c):g.insertAdjacentHTML("afterEnd",c.outerHTML);for(var h=0;h<g.attributes.length;h++)this[g.attributes[h].name]=g.attributes[h].value;g.parentNode.removeChild(g)}return this.onUnsupportedVisualization=new Subscription,this.searchEntity.ready.subscribe(this.activate.bind(this)),{element:c,object:this}}function b(a,b){for(var c=[],d=0;d<a.length;d++)if(a[d].dimension){var e={qDef:{qFieldDefs:[a[d].dimension]},qNullSuppression:a[d].suppressNull};if(b[a[d].dimension]){var f={};if("array"==typeof b[a[d].dimension].sortType)for(var g=0;g<b[a[d].dimension].sortType.length;g++)f[b[a[d].dimension].sortType[g]]=b[a[d].dimension].order[g];else f[b[a[d].dimension].sortType]=b[a[d].dimension].order;b[a[d].dimension].sortExpression&&(f.qExpression=b[a[d].dimension].sortExpression),e.qDef.qSortCriterias=[f]}c.push(e)}return c}function c(a){for(var b=[],c=0;c<a.length;c++)if(a[c].measure){var d={qDef:{qLabel:a[c].label,qDescription:"",qDef:a[c].measure}};if(a[c].sortType)if(d.qSortBy={},"array"==typeof a[c].sortType)for(var e=0;e<a[c].sortType.length;e++)d.qSortBy[a[c].sortType[e]]=a[c].order[e];else d.qSortBy[a[c].sortType]=a[c].order;b.push(d)}return b}var d="<div id='{id}_results_loading' class='sense-search-results_loading on'><div class='sense-search-results_loading-spinner'>Loading...</div></div><div id='{id}_results' class='sense-search-results'></div>";return a.prototype=Object.create(Object.prototype,{id:{writable:!0,value:!1},handle:{writable:!0,value:!1},activate:{value:function(){this.attach()}},attached:{writable:!0,value:!1},searchEntity:{writable:!0},attach:{value:function(a,b){var c=this;if(a)for(var d in a)this[d]=a[d];if(this.currentSort=this.defaultSort,this.searchEntity&&this.searchEntity.exchange.connection){if(a&&a.fields){var e=this.buildHyperCubeDef();"CapabilityAPI"==this.searchEntity.exchange.connectionType?this.searchEntity.exchange.app.createCube(e.qHyperCubeDef,this.onSearchResults.bind(this)).then(function(a){console.log(a),c.handle=a.handle,"function"==typeof b&&b.call(null)},logError):this.searchEntity.exchange.ask(this.searchEntity.appHandle,"CreateSessionObject",[e],function(a){c.handle=a.result.qReturn.qHandle,"function"==typeof b&&b.call(null)})}this.attached||(this.searchEntity.searchStarted.subscribe(this.onSearchStarted.bind(this)),this.searchEntity.searchResults.subscribe(this.onSearchResults.bind(this)),this.searchEntity.noResults.subscribe(this.onNoResults.bind(this)),this.searchEntity.chartResults.subscribe(this.onChartResults.bind(this)),this.searchEntity.cleared.subscribe(this.onClear.bind(this)),this.attached=!0),this.searchEntity.results[this.id]=this}this.hideLoading()}},fields:{writable:!0,value:[]},data:{writable:!0,value:[]},sortOptions:{writable:!0,value:{}},defaultSort:{writable:!0,value:null},currentSort:{writable:!0,value:null},enableHighlighting:{writable:!0,value:!0},pageTop:{writable:!0,value:0},pageSize:{writable:!0,value:20},pagesLoaded:{writable:!0,value:[]},buildHyperCubeDef:{value:function(){var a={qInfo:{qType:"table"},qHyperCubeDef:{qDimensions:b(this.fields,this.sortOptions),qMeasures:c(this.fields),qSuppressZero:!1,qSuppressMissing:!1,qInterColumnSortOrder:this.getInterColumnSortOrder(this.getFieldIndex(this.defaultSort).index)}};return a}},resultsElement:{writable:!0,value:null},latestLayout:{writable:!0,value:null},showLoading:{value:function(){var a=document.getElementById(this.loadingElement);a&&a.classList.add("on")}},hideLoading:{value:function(){var a=document.getElementById(this.loadingElement);a&&a.classList.remove("on")}},onSearchStarted:{value:function(){this.showLoading()}},onSearchResults:{value:function(a){this.hideLoading(),this.data=[],this.pageTop=0,this.pagesLoaded=[],this.handle&&this.getHyperCubeData()}},onChartResults:{value:function(a){console.log("Chart created"),this.searchEntity.vizIdList.push(a.id),this.hideLoading();var b=document.createElement("div");b.classList.add("chart-result");var c=document.getElementById(this.resultsElement);c.innerHTML="",c&&c.appendChild(b),this.searchEntity.usePicasso===!0&&"undefined"!=typeof senseSearchPicasso?senseSearchPicasso.isSupported(a.model.genericType)?senseSearchPicasso.render(b,a):this.onUnsupportedVisualization.deliver(a):"CapabilityAPI"==this.searchEntity.exchange.connectionType&&a.show(b)}},onNoResults:{writable:!0,value:function(){this.hideLoading(),this.renderItems([])}},onClear:{writable:!0,value:function(){this.hideLoading(),document.getElementById(this.id+"_results").innerHTML=""}},getNextBatch:{value:function(){this.pageTop+=this.pageSize,this.getHyperCubeData()}},getHyperCubeData:{value:function(a){var b=this;this.searchEntity.exchange.getLayout(this.handle,function(c){var d=c.result.qLayout;b.latestLayout=d,console.trace();var e=d.qHyperCube.qDimensionInfo.concat(d.qHyperCube.qMeasureInfo);this.searchEntity.exchange.ask(b.handle,"GetHyperCubeData",["/qHyperCubeDef",[{qTop:b.pageTop,qLeft:0,qHeight:b.pageSize,qWidth:b.fields.length}]],function(c){if(this.searchEntity.exchange.seqId==c.id)if(a&&"function"==typeof a)a.call(this,c);else{for(var d=c.result.qDataPages,f=[],g=0;g<d[0].qMatrix.length;g++){var h={};if(!b.nullSuppressor||null==b.nullSuppressor||"-"!=d[0].qMatrix[g][b.nullSuppressor].qText){for(var i=0;i<d[0].qMatrix[g].length;i++)h[e[i].qFallbackTitle]={value:d[0].qMatrix[g][i].qText,html:b.highlightText(d[0].qMatrix[g][i].qText)};f.push(h)}}var j=b.pageTop/b.pageSize;-1==b.pagesLoaded.indexOf(j)&&(b.pagesLoaded.push(j),b.data=b.data.concat(f)),b.renderItems(f)}})})}},getFieldIndex:{value:function(a){for(var b=0;b<this.fields.length;b++){if(this.fields[b].dimension&&this.fields[b].dimension==a)return{index:b,type:"dimension"};if(this.fields[b].label&&this.fields[b].label==a)return{index:b,type:"measure"}}return 0}},getInterColumnSortOrder:{value:function(a){for(var b=[a],c=0;c<this.fields.length;c++)c!=a&&b.push(c);return b}},highlightText:{value:function(a){if(this.searchEntity.terms&&this.enableHighlighting){for(var b=this.searchEntity.terms,c=0;c<b.length;c++)a=a.replace(new RegExp(b[c],"i"),"<span class='highlight"+c+"'>"+b[c]+"</span>");return a}return a}},renderItems:{writable:!0,value:function(a){if(this.data.length>0){var b=document.getElementById(this.id+"_ul");b||(b=document.createElement("ul"),b.id=this.id+"_ul",document.getElementById(this.id+"_results").appendChild(b));var c="",d=0;for(var e in a[0])d++;var f=Math.floor(100/d);c+="<li>";for(var g in a[0])c+="<div class='sense-search-result-cell' style='width: "+f+"%'>",c+="<strong>"+g+"</strong>",c+="</div>";c+="</li>";for(var h=0;h<a.length;h++){c+="<li>";for(var g in a[h])c+="<div class='sense-search-result-cell' style='width: "+f+"%'>",c+=a[h][g].html,c+="</div>";c+="</li>"}document.getElementById(this.id+"_ul").innerHTML=c}else c="<h1>No Results</h1>",document.getElementById(this.resultsElement).innerHTML=c}},applySort:{value:function(a,b,c){var d=this;this.currentSort=a,b=b||!1,c=c||!1,this.searchEntity.exchange.ask(this.handle,"ApplyPatches",[[{qPath:"/qHyperCubeDef/qInterColumnSortOrder",qOp:"replace",qValue:JSON.stringify(d.getInterColumnSortOrder(d.getFieldIndex(a).index))}],!0],function(){b&&(d.pageTop=0,d.pagesLoaded=[]),c&&1==c&&d.getHyperCubeData()})}},invertSort:{value:function(a,b,c){var d,e=this,f=this.getFieldIndex(a);d="dimension"==f.type?"/qHyperCubeDef/qDimensions/"+f.index+"/qDef/qReverseSort":"/qHyperCubeDef/qMeasures/"+f.index+"/qDef/qReverseSort";var e=this;b=b||!1,c=c||!1,this.searchEntity.exchange.ask(this.handle,"ApplyPatches",[[{qPath:"/qHyperCubeDef/qInterColumnSortOrder",qOp:"replace",qValue:JSON.stringify(e.getInterColumnSortOrder(f.index))},{qPath:d,qOp:"replace",qValue:"true"}],!0],function(){b&&(e.pageTop=0,e.pagesLoaded=[]),c&&1==c&&e.getHyperCubeData()})}}}),a}();Subscription.prototype=Object.create(Object.prototype,{subscribe:{value:function(a){this.callbackList.push(a)}},deliver:{value:function(a){for(var b=0;b<this.callbackList.length;b++)this.callbackList[b].call(null,a)}}});var SenseSearch=function(){function a(){var a,b,c=0,d=10;this.connect=function(e,f){b=f;try{a=new WebSocket(e)}catch(g){}a.onopen=function(){console.log("Socket connected! readyState = "+a.readyState),c=0,b.call(null,{method:"connected"})},a.onmessage=function(a){var c;c=a.data,b.call(null,JSON.parse(c))},a.onerror=function(a){b.call(null,null)},a.onclose=function(e){d>c?(c++,console.warn("Socket closed! --> Reconnect in 5 secs (retry "+c+")"),setTimeout(function(){3===a.readyState&&b.call(null,{method:"socketClosed",isConnecting:!1})},5e3)):(console.warn("Sorry, can't reconnect socket aftet "+d+" retries"),c=0)}},this.sendMessage=function(c,d){b=d;try{a.send(JSON.stringify(c))}catch(e){throw e}}}function b(a){console.log(a)}function c(){this.reboot()}var d=function(){function b(b,c){if(!b.app)return!1;b=b||{},b.host?b.port=b.port||"":b.port="4848",b.host=b.host||"localhost",b.prefix=b.prefix||"",b.isSecure=b.isSecure||"https:"==window.location.protocol,b.ticket=b.ticket||!1;var d="ws";d+=b.isSecure?"s://":"://",d+=b.host,d+=b.port?":"+b.port:"",d+=b.prefix,d+="/app/",d+=b.app,d+=b.ticket?"qlikTicket="+b.ticket:"",this.connection=new a,this.connection.connect(d,c)}return b.prototype=Object.create(Object.prototype,{connection:{writable:!0,value:null},ask:{value:function(a,b,c,d,e){var f={id:d,handle:a,method:b,params:c};this.connection.sendMessage(f,e)}}}),b}(),e=function(){function a(a,b,c){var e=this;this.connectionType=b,"Native"==b?this.connection=new d(a,function(){e.connection.ask(-1,"OpenDoc",[a.app],0,function(a){c.call(null,a)})}):"QSocks"==b?(this.connection=a,this.seqId=this.connection.seqid):"Enigma"==b?(this.connection=a.session,this.seqId=this.connection.rpc.requestId,this.app=a):"CapabilityAPI"==b&&(this.connection=a.global.session,this.app=a)}return a.prototype=Object.create(Object.prototype,{connectionType:{writable:!0,value:null},seqId:{writable:!0,value:0},pendingCallbacks:{writable:!0,value:{}},connection:{writable:!0,value:null},ask:{value:function(a,b,c,d){switch(this.connectionType){case"Native":this.askNative(a,b,c,d);break;case"QSocks":this.askQSocks(a,b,c,d);break;case"CapabilityAPI":this.askCapabilityAPI(a,b,c,d);break;case"Enigma":this.askEnigma(a,b,c,d)}"Native"==this.connectionType}},createCapabilityViz:{value:function(){}},askNative:{value:function(a,b,c,d){var e=this;this.seqId++,this.pendingCallbacks[this.seqId]=d,this.connection.ask(a,b,c,this.seqId,function(a){if(a.error);else{var b=e.pendingCallbacks[a.id];b&&(b.call(null,a),delete e.pendingCallbacks[a.id])}})}},askQSocks:{value:function(a,c,d,e){this.connection.seqid++,this.seqId=this.connection.seqid,this.connection.ask(a,c,d,this.connection.seqid).then(function(a){a.error||e.call(null,a)},b)}},askCapabilityAPI:{value:function(a,c,d,e){var f=this;try{this.connection.__enigmaSession.rpc.send({handle:a,method:c,params:d}).then(function(a){f.seqId=a.id,a.error||e.call(null,a)},b)}catch(g){console.log(g),this.connection.rpc({handle:a,method:c,params:d}).then(function(a){f.seqId=a.id,a.error||e.call(null,a)},b)}}},askEnigma:{value:function(a,c,d,e){var f=this;this.connection.rpc.send({handle:a,method:c,params:d,outKey:-1,delta:!1}).then(function(a){f.seqId=a.id,a.error||e.call(null,a)},b)}},getLayout:{value:function(a,b){this.ask(a,"GetLayout",[],b)}}}),a}();return c.prototype=Object.create(Object.prototype,{init:{value:function(){for(var a=document.getElementsByTagName("sense-search-input"),b=0;b<a.length;)this.inputs[a[b].id]=new SenseSearchInput(a[b].id).object;for(var c=document.getElementsByTagName("sense-search-speech"),b=0;b<c.length;)this.speech[c[b].id]=new SenseSearchSpeech(c[b].id).object;for(var d=document.getElementsByTagName("sense-search-results"),b=0;b<d.length;)this.results[d[b].id]=new SenseSearchResult(d[b].id).object}},reboot:{value:function(){this.ready=new Subscription,this.searchStarted=new Subscription,this.searchResults=new Subscription,this.searchAssociations=new Subscription,this.fieldsFetched=new Subscription,this.noResults=new Subscription,this.suggestResults=new Subscription,this.chartResults=new Subscription,this.onSelectionsApplied=new Subscription,this.onSelectionsError=new Subscription,this.onLockedUnlocked=new Subscription,this.cleared=new Subscription,this.inputs=[],this.results=[]}},usePicasso:{writable:!0,value:!1},appFields:{writable:!0,value:{}},appFieldsByTag:{writable:!0,value:{}},fieldsForSelecting:{value:[]},fieldHandles:{value:[]},inputs:{writable:!0,value:{}},speech:{writable:!0,value:{}},results:{writable:!0,value:{}},pendingSearch:{writable:!0,value:null},pendingSuggest:{writable:!0,value:null},pendingChart:{writable:!0,value:null},appHandle:{writable:!0,value:null},exchange:{writable:!0,value:null},searchInput:{value:SenseSearchInput},vizIdList:{writable:!0,value:[]},connect:{value:function(a,b){var c=this;this.exchange=new e(a,"Native",function(a){a.result&&a.result.qReturn&&(c.appHandle=a.result.qReturn.qHandle,c.ready.subscribe(b),c.ready.deliver())})}},connectWithQSocks:{value:function(a){this.appHandle=a.handle,this.exchange=new e(a.connection,"QSocks"),this.ready.deliver()}},connectWithCapabilityAPI:{value:function(a){this.appHandle=a.global.session.connectedAppHandle||a.model.handle,this.exchange=new e(a,"CapabilityAPI"),this.ready.deliver()}},connectWithEnigma:{value:function(a){this.appHandle=a.session.apis.entries[1].api.handle,this.exchange=new e(a,"Enigma"),this.ready.deliver()}},readOptions:{value:function(a){for(var b in a)this[0]=a[b]}},ready:{writable:!0,value:null},newResultsDefinition:{value:function(a,b,c){var d=new Result(a);this.results.push(d)}},fieldsFetched:{writable:!0,value:null},searchingForVizValues:{writable:!0,value:!1},vizSearchQueue:{writable:!0,value:[]},vizAssociationResults:{writable:!0,value:[]},search:{value:function(a,b,c,d){this.searchStarted.deliver();var e=this;if(c=c||"simple",d=d||this.context||"LockedFieldsOnly",this.pendingSearch=this.exchange.seqId+1,"visualizations"==c&&0==this.searchingForVizValues)this.searchingForVizValues=!0;else if("visualizations"==c)return this.vizSearchQueue.push([a,b,c,d]),void console.log("vis search queue length",this.vizSearchQueue.length);this.terms=a.split(" "),this.exchange.ask(this.appHandle,"SearchResults",[{qContext:d,qSearchFields:b},this.terms,{qOffset:0,qCount:5,qMaxNbrFieldMatches:5}],function(f){"visualizations"==c?(e.searchingForVizValues=!1,e.vizAssociationResults.push(f.result.qResult),e.vizSearchQueue.length>0?(console.log("adding to queue"),e.search(e.vizSearchQueue[0][0],e.vizSearchQueue[0][1],e.vizSearchQueue[0][2],e.vizSearchQueue[0][3]),e.vizSearchQueue.splice(0,1)):(console.log("delivering queue"),e.vizSearchQueue=[],this.searchingForVizValues=!1,e.searchAssociations.deliver(e.vizAssociationResults),e.vizAssociationResults=[])):f.id==e.pendingSearch&&(""==a||f.result.qResult.qTotalNumberOfGroups>0?"simple"==c?e.selectAssociations(b,0,d):e.searchAssociations.deliver(f.result):e.noResults.deliver())})}},selectAssociations:{value:function(a,b,c){c=c||this.context||"LockedFieldsOnly";var d=this;d.exchange.ask(d.appHandle,"SelectAssociations",[{qContext:c,qSearchFields:a},d.terms,b],function(a){d.searchResults.deliver(a.change)})}},searchAndSelect:{value:function(a,b,c,d){this.searchStarted.deliver();var e=this;d=d||this.context||"LockedFieldsOnly",this.pendingSearch=this.exchange.seqId+1,this.terms=a.split(" "),this.exchange.ask(this.appHandle,"SearchResults",[{qContext:d,qSearchFields:b},this.terms,{qOffset:0,qCount:5,qMaxNbrFieldMatches:5}],function(f){(f.id==e.pendingSearch||f.id==e.exchange.seqId)&&(""==a||f.result.qResults.qTotalSearchResults>0?e.selectAssociations(b,c,d):e.noResults.deliver())})}},suggest:{value:function(a,b,c){var d=this;d.pendingSuggest=this.exchange.seqId+1,this.exchange.ask(this.appHandle,"SearchSuggest",[{qContext:c||this.context||"LockedFieldsOnly",qSearchFields:b},a.split(" ")],function(a){a.id==d.pendingSuggest&&d.suggestResults.deliver(a.result.qResult)})}},lowLevelSelectTextInField:{value:function(a,b,c,d){var e;a.id||(e={qFieldDefs:[a.name]});var f=this,g={qInfo:{qType:"LB"},qListObjectDef:{qDef:e,qLibraryId:a.id,qInitialDataFetch:[{qTop:0,qLeft:0,qWidth:1,qHeight:1e4}]}},h=[];this.exchange.ask(this.appHandle,"CreateSessionObject",[g],function(a){if(null==a.result.qReturn.qHandle)f.onSelectionsError.deliver();else{var e=a.result.qReturn.qHandle;f.exchange.ask(e,"GetLayout",[],function(a){var g=a.result.qLayout;if(g.qListObject.qDataPages[0]){for(var i=g.qListObject.qDataPages[0].qMatrix,j=0;j<i.length;j++)for(var k=0;k<b.length;k++)i[j][0].qText&&-1!==i[j][0].qText.toLowerCase().indexOf(b[k].toLowerCase())&&h.push(i[j][0].qElemNumber);f.exchange.ask(e,"SelectListObjectValues",["/qListObjectDef",h,c],function(){d&&"function"==typeof d&&d()})}})}})}},selectTextInField:{value:function(a,b,c,d){c=null==c?!0:!1;for(var e=this,f=[],g=0;g<b.length;g++)f.push({qText:b[g]});if(-1===this.fieldsForSelecting.indexOf(a))this.exchange.ask(this.appHandle,"GetField",[a],function(b){if(null==b.result.qReturn.qHandle)this.onSelectionsError.deliver();else{var g=b.result.qReturn.qHandle;e.fieldHandles.push(g),e.fieldsForSelecting.push(a),e.exchange.ask(g,"SelectValues",[f,c],function(a){d?d():e.onSelectionsApplied.deliver()})}});else{var h=this.fieldHandles[this.fieldsForSelecting.indexOf(a)];this.exchange.ask(h,"SelectValues",[f,c],function(a){d?d():e.onSelectionsApplied.deliver()})}}},selectInField:{value:function(a,b,c){c=null==c?!0:!1;var d=this;if(-1===this.fieldsForSelecting.indexOf(a))this.exchange.ask(this.appHandle,"GetField",[a],function(e){if(null==e.result.qReturn.qHandle)this.onSelectionsError.deliver();else{var f=e.result.qReturn.qHandle;d.fieldHandles.push(f),d.fieldsForSelecting.push(a),d.exchange.ask(f,"LowLevelSelect",[b,c],function(a){d.onSelectionsApplied.deliver()})}});else{var e=this.fieldHandles[this.fieldsForSelecting.indexOf(a)];this.exchange.ask(e,"LowLevelSelect",[b,c],function(a){d.onSelectionsApplied.deliver()})}}},createViz:{value:function(a){console.log(a),this.searchStarted.deliver();var c=this;if(c.pendingChart=this.exchange.seqId+1,"CapabilityAPI"==this.exchange.connectionType){var d=a;d.wsId=c.pendingChart;var e="/qHyperCubeDef",f=d.qHyperCubeDef;"kpi"==a.qInfo.qType&&(d.color={useBaseColors:"measure"},d.qHyperCubeDef.qMeasures[0]&&!d.qHyperCubeDef.qMeasures[0].qDef&&(d.qHyperCubeDef.qMeasures[0].qDef={}),d.qHyperCubeDef.qMeasures[0].qDef.measureAxis={min:0,max:100},d.qHyperCubeDef.qMeasures[0].qDef.conditionalColoring={useConditionalColoring:!1,singleColor:3,paletteSingleColor:{index:6},segments:{limits:[],paletteColors:[{index:6}]}},d.fontSize="S"),"boxplot"==a.qInfo.qType&&(e="/boxplotDef/qHyperCubeDef",d.boxplotDef={qHyperCubeDef:d.qHyperCubeDef},d.boxplotDef.qHyperCubeDef.calculations={auto:!0,mode:"tukey",parameters:{tukey:1.5,fractiles:.01,stdDev:3}},d.boxplotDef.qHyperCubeDef.elements={firstWhisker:{name:"",expression:null},boxStart:{name:"",expression:null},boxMiddle:{name:"",expression:null},boxEnd:{name:"",expression:null},lastWhisker:{name:"",expression:null},outliers:{include:!0}},d.boxplotDef.qHyperCubeDef.presentation={whiskers:{show:!0}},d.boxplotDef.qHyperCubeDef.color={box:{paletteColor:{index:-1,color:"#E6E6E6"}},point:{paletteColor:{index:6,color:"#4477aa"}}},delete d.qHyperCubeDef,f=d.boxplotDef.qHyperCubeDef),this.exchange.app.visualization.create(a.qInfo.qType,[],d).then(function(b){if(c.vizIdList.push(b.id),"table"==a.qInfo.qType){
var e=new Array(d.qHyperCubeDef.qDimensions.length+d.qHyperCubeDef.qMeasures.length).fill().map(function(a,b){return b}),f=[{qOp:"replace",qPath:"/qHyperCubeDef/columnOrder",qValue:JSON.stringify(e)}];c.exchange.ask(b.model.handle,"ApplyPatches",[f,!0],function(a){c.chartResults.deliver(b)})}else c.chartResults.deliver(b)},b)}else{var g={10:["table"],"01":["kpi","table"],11:["barchart","piechart","linechart"],12:["barchart","linechart","scatterplot"],20:["table"],"02":["table"],21:["barchart","linchart"],22:["scatterplot"],30:["table"]},h=a.qHyperCubeDef.qDimensions.length.toString()+a.qHyperCubeDef.qMeasures.length.toString(),i=g[h]||[];console.log(i),this.exchange.ask(this.appHandle,"CreateSessionObject",[a],function(a){c.vizIdList.push(a.result.qReturn.qGenericId),console.log("Chart response id is",a.id),console.log("pendingChart id is",c.pendingChart),a.id>=c.pendingChart&&("Enigma"==c.exchange.connectionType?c.exchange.app.getObject(a.result.qReturn.qGenericId).then(function(a){c.chartResults.deliver({model:a,layout:null,altVizList:i})}):c.exchange.ask(a.result.qReturn.qHandle,"GetLayout",[],function(b){c.chartResults.deliver({model:a.result.qReturn,layout:b.result.qLayout,altVizList:i})}))})}}},cleanUpOldVizObjects:{value:function(){for(var a=0;a<this.vizIdList.length;a++)this.vizIdList[a]&&this.destroyObject(this.vizIdList[a]);this.vizIdList=[]}},destroyObject:{value:function(a){this.exchange.ask(this.appHandle,"DestroySessionObject",[a],function(a){})}},clear:{value:function(a,b,c){var d=this;a===!0?this.exchange.ask(this.appHandle,"UnlockAll",[],function(a){d.exchange.ask(d.appHandle,"ClearAll",[],function(a){b||(d.terms=null,d.cleared.deliver()),c&&"function"==typeof c&&c()})}):this.exchange.ask(this.appHandle,"ClearAll",[],function(a){b||(d.terms=null,d.cleared.deliver()),c&&"function"==typeof c&&c()})}},getAppFields:{value:function(a,b){var c=this,d=2;b&&d++;var e={fields:null,dimensions:null,measures:null,setCount:0};c.exchange.ask(c.appHandle,"CreateSessionObject",[{qInfo:{qType:"FieldList"},qFieldListDef:{qShowSystem:!1}}],function(b){var f=b.result.qReturn.qHandle;c.exchange.ask(f,"GetLayout",[],function(b){e.fields=b.result.qLayout.qFieldList.qItems,e.setCount++,e.setCount===d&&c.sortFieldsByTag(e,a)})}),c.exchange.ask(c.appHandle,"CreateSessionObject",[{qInfo:{qType:"DimensionList"},qDimensionListDef:{qType:"dimension",qData:{title:"/qMetaDef/title",tags:"/qMetaDef/tags",grouping:"/qDim/qGrouping",info:"/qDimInfos"}}}],function(b){var f=b.result.qReturn.qHandle;c.exchange.ask(f,"GetLayout",[],function(b){e.dimensions=b.result.qLayout.qDimensionList.qItems,e.setCount++,e.setCount===d&&c.sortFieldsByTag(e,a)})}),b&&c.exchange.ask(c.appHandle,"CreateSessionObject",[{qInfo:{qType:"MeasureList"},qMeasureListDef:{qType:"measure",qData:{title:"/qMetaDef/title",tags:"/qMetaDef/tags"}}}],function(b){var f=b.result.qReturn.qHandle;c.exchange.ask(f,"GetLayout",[],function(b){e.measures=b.result.qLayout.qMeasureList.qItems,e.setCount++,e.setCount===d&&c.sortFieldsByTag(e,a)})})}},sortFieldsByTag:{value:function(a,b){var c=[],d=[];this.appFields={},this.appFieldsByTag={$dimension:{},$measure:{},$possibleMeasure:{}};for(var e=0;e<a.dimensions.length;e++){var f=a.dimensions[e].qData.title.toLowerCase().replace(/ /gi,"_");if(-1===d.indexOf(f)){d.push(f),a.dimensions[e].fieldName=f,c.push(a.dimensions[e]),this.appFieldsByTag.$dimension[f]={fieldName:a.dimensions[e].qData.title},a.fields[e].qCardinal>b&&(this.appFieldsByTag.$possibleMeasure||(this.appFieldsByTag.$possibleMeasure={}),this.appFieldsByTag.$possibleMeasure[f]={fieldName:a.fields[e].qName});for(var g=0;g<a.dimensions[e].qMeta.tags.length;g++){var h=a.dimensions[e].qMeta.tags[g];-1==h.indexOf("$")&&(h="$"+h),this.appFieldsByTag[h]||(this.appFieldsByTag[h]={}),this.appFieldsByTag[h][f]={fieldName:a.dimensions[e].qData.title}}}}if(a.measures&&Array.isArray(a.measures))for(var e=0;e<a.measures.length;e++){var f=a.measures[e].qData.title.toLowerCase().replace(/ /gi,"_");if(-1===d.indexOf(f)){d.push(f),a.measures[e].fieldName=f,a.measures[e].isMasterItem=!0,c.push(a.measures[e]),this.appFieldsByTag.$measure[f]={fieldName:a.measures[e].qData.title};for(var g=0;g<a.measures[e].qMeta.tags.length;g++){var h=a.measures[e].qMeta.tags[g];-1==h.indexOf("$")&&(h="$"+h),this.appFieldsByTag[h]||(this.appFieldsByTag[h]={}),this.appFieldsByTag[h][f]={fieldName:a.measures[e].qData.title}}}}for(var e=0;e<a.fields.length;e++){var f=a.fields[e].qName.toLowerCase().replace(/ /gi,"_");if(-1===d.indexOf(f)){d.push(f),a.fields[e].fieldName=f,c.push(a.fields[e]);for(var g=0;g<a.fields[e].qTags.length;g++)this.appFieldsByTag[a.fields[e].qTags[g]]||(this.appFieldsByTag[a.fields[e].qTags[g]]={}),this.appFieldsByTag[a.fields[e].qTags[g]][f]={fieldName:a.fields[e].qName};a.fields[e].qCardinal>b&&(this.appFieldsByTag.$possibleMeasure||(this.appFieldsByTag.$possibleMeasure={}),this.appFieldsByTag.$possibleMeasure[f]={fieldName:a.fields[e].qName})}}c.sort(function(a,b){return b.fieldName.split("_").length-a.fieldName.split("_").length});for(var e=0;e<c.length;e++)this.appFields[c[e].fieldName]=c[e];this.fieldsFetched.deliver()}},searchStarted:{writable:!0,value:null},searchResults:{writable:!0,value:null},searchAssociations:{writable:!0,value:null},selectionsApplied:{writable:!0,value:null},onSelectionsError:{writable:!0,value:null},lockedUnlocked:{writable:!0,value:null},noResults:{writable:!0,value:null},chartResults:{writable:!0,value:null},suggestResults:{writable:!0,value:null}}),c}();if("undefined"!=typeof document){var senseSearch=new SenseSearch;senseSearch.init()}else module.exports=new SenseSearch;